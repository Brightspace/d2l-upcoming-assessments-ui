<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">
<link rel="import" href="./date-behavior.html">

<script src="../../fetch/fetch.js"></script>
<script src="https://s.brightspace.com/lib/d2lfetch/1.2.0/d2lfetch.js"></script>
<script src="https://s.brightspace.com/lib/siren-parser/6.0.0/siren-parser.js"></script>
<script>
	'use strict';

	window.D2L = window.D2L || {};
	window.D2L.UpcomingAssessments = window.D2L.UpcomingAssessments || {};

	/*
	* @polymerBehavior window.D2L.UpcomingAssessments.UpcomingAssessmentsBehavior
	*/
	var upcomingAssessmentsBehaviorImpl = {

		_getActivityUsagesInfo: function(activities, getToken, userUrl) {
			var requests = [];
			var self = this;
			var overdueActivitiesRequest = self._getOverdueActivities(activities, getToken, userUrl);

			var assignmentEntities = activities.getSubEntitiesByClass('user-assignment-activity');
			var quizEntities = activities.getSubEntitiesByClass('user-quiz-activity');
			[].concat(assignmentEntities).concat(quizEntities).forEach(function(assessment) {
				if (!assessment.getSubEntityByClass(self.HypermediaClasses.dates.dueDate)
					&& !assessment.getSubEntityByClass(self.HypermediaClasses.dates.endDate)
				) {
					return;
				}
				var orgUnitLink = (assessment.getLinkByRel(self.HypermediaRels.organization) || {}).href;
				var activityUsageLink = assessment.getLinkByRel(self.HypermediaRels.Activities.activityUsage).href;
				var activityIsComplete = !!assessment.getSubEntityByClass('complete');

				var activityUsageRequest = self._fetchEntity(activityUsageLink, getToken, userUrl);
				var assessmentSelfHref = assessment.getLinkByRel('self').href;

				var request = new Promise(function(resolve) {
					Promise.all([activityUsageRequest, overdueActivitiesRequest])
						.then(function(response) {
							var activityUsageEntity = response[0];
							var overdueActivitiesEntity = response[1];
							var isOverdue = false;
							if (overdueActivitiesEntity) {
								var overdueActivities = [];
								overdueActivities = overdueActivities.concat(overdueActivitiesEntity.getSubEntitiesByClass('user-quiz-activity'));
								overdueActivities = overdueActivities.concat(overdueActivitiesEntity.getSubEntitiesByClass('user-assignment-activity'));
								isOverdue = overdueActivities.some(function(usage) {
									return usage.getLinkByRel('self').href === assessmentSelfHref;
								});
							}
							resolve({
								activityIsComplete: activityIsComplete,
								activityIsOverdue: isOverdue,
								activityUsage: activityUsageEntity,
								orgUnitLink: orgUnitLink
							});
						});
				});

				requests.push(request);
			});

			return Promise.all(requests);
		},

		_getUserActivityUsageInfo: function(responses, getToken, userUrl) {
			var requests = [];
			var orgPromiseMap = {};
			var self = this;

			responses.forEach(function(response) {
				if (!response.activityUsage.hasClass('published')) {
					return;
				}

				var assessmentLink = (response.activityUsage.getLinkByRel(self.HypermediaRels.assignment)
					|| response.activityUsage.getLinkByRel(self.HypermediaRels.quiz)).href;
				var orgUnitRequest = orgPromiseMap[response.orgUnitLink];

				var activityIsComplete = response.activityIsComplete;
				var activityIsOverdue = response.activityIsOverdue;
				var activityIsDueToday = false;

				var dueDate;
				var dueDateEntity = response.activityUsage.getSubEntityByClass(self.HypermediaClasses.dates.dueDate);
				if (dueDateEntity) {
					dueDate = dueDateEntity.properties.date;
					// If there is no due date, the default value of false is correct
					activityIsDueToday = !activityIsComplete
						&& !activityIsOverdue
						&& self.getDateDiffInCalendarDays(dueDate) === 0;
				}

				var endDate;
				var endDateEntity = response.activityUsage.getSubEntityByClass(self.HypermediaClasses.dates.endDate);
				if (endDateEntity) {
					endDate = endDateEntity.properties.date;
				}

				if (!orgUnitRequest) {
					orgUnitRequest = self._fetchEntity(response.orgUnitLink, getToken, userUrl);
					orgPromiseMap[response.orgUnitLink] = orgUnitRequest;
				}

				var assessmentRequest = self._fetchEntity(assessmentLink, getToken, userUrl);

				var request = new Promise(function(resolve) {
					Promise.all([assessmentRequest, orgUnitRequest])
						.then(function(response) {
							var activity = response[0];
							var organization = response[1];

							var type;
							if (activity.hasClass('assignment')) {
								type = 'assignment';
							} else if (activity.hasClass('quiz')) {
								type = 'quiz';
							}

							resolve({
								name: activity.properties.name,
								courseName: organization.properties.name,
								dueDate: dueDate,
								endDate: endDate,
								instructions: activity.properties.instructionsText || activity.properties.instructions,
								isCompleted: activityIsComplete,
								isDueToday: activityIsDueToday,
								isOverdue: activityIsOverdue,
								type: type
							});
						});
				});

				requests.push(request);
			});

			return Promise.all(requests);
		},

		_getOverdueActivitiesList: function(userUrl, getToken) {
			var self = this;

			return this._fetchEntity(userUrl)
				.then(function(userEntity) {
					return self._getUserActivityUsages(userEntity, getToken, userUrl);
				})
				.then(function(activities) {
					self._setTotalCount(self._getTotalCount(activities, getToken, userUrl));

					return self._getOverdueActivities(activities, getToken, userUrl);
				});
		},

		_getUserActivityUsages: function(userEntity, getToken, userUrl) {
			var myActivitiesLink = (userEntity.getLinkByRel(this.HypermediaRels.Activities.myActivities) || {}).href;

			if (myActivitiesLink) {
				return this._fetchEntity(myActivitiesLink, getToken, userUrl);
			}
		},

		_getOverdueActivities: function(activities, getToken, userUrl) {
			var overdueActivitiesLink = (activities.getLinkByRel(this.HypermediaRels.Activities.overdue) || {}).href;

			if (overdueActivitiesLink) {
				return this._fetchEntity(overdueActivitiesLink, getToken, userUrl);
			}
		},

		_getTotalCount: function(activities) {
			var self = this;
			var activityEntities = [];
			activityEntities = activityEntities.concat(activities.getSubEntitiesByClass('user-assignment-activity'));
			activityEntities = activityEntities.concat(activities.getSubEntitiesByClass('user-quiz-activity'));
			return (activityEntities)
				.map(function(assignment) {
					return {
						dueDate: ((assignment.getSubEntityByClass(self.HypermediaClasses.dates.dueDate) || {}).properties || {}).date,
						endDate: ((assignment.getSubEntityByClass(self.HypermediaClasses.dates.endDate) || {}).properties || {}).date
					};
				})
				.filter(function(item) {
					return self.isActivityUpcoming(item);
				})
				.length;
		},

		_getOverdueCount: function(overdueActivities) {
			var activityEntities = [];
			activityEntities = activityEntities.concat(overdueActivities.getSubEntitiesByClass('user-assignment-activity'));
			activityEntities = activityEntities.concat(overdueActivities.getSubEntitiesByClass('user-quiz-activity'));
			return (activityEntities).length;
		},

		_fetchEntity: function(url, getToken, userUrl) {
			var tokenUrl = userUrl || url;
			if (url && typeof getToken === 'function' && tokenUrl) {
				return getToken(tokenUrl)
					.then(function(token) {
						if (typeof token === 'string') {
							return this._makeRequest(token, url);
						} else {
							throw new Error('token expected to be a string');
						}
					}.bind(this));
			}
		},

		_makeRequest: function(token, url) {
			var request = new Request(url, {
				headers: new Headers({
					Accept: 'application/vnd.siren+json',
					Authorization: 'Bearer ' + token
				})
			});

			return window.d2lfetch
				.fetch(request)
				.then(function(response) {
					if (response.ok) {
						return response.json();
					}
					return Promise.reject(response.status);
				})
				.then(window.D2L.Hypermedia.Siren.Parse);
		}
	};

	window.D2L.UpcomingAssessments.UpcomingAssessmentsBehavior = [
		window.D2L.UpcomingAssessments.DateBehavior,
		window.D2L.Hypermedia.HMConstantsBehavior,
		upcomingAssessmentsBehaviorImpl
	];

</script>
