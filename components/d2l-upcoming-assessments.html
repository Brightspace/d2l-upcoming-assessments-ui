<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-colors/d2l-colors.html">
<link rel="import" href="../../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">
<link rel="import" href="../../d2l-intl/d2l-intl.html">
<link rel="import" href="../../d2l-link/d2l-link.html">
<link rel="import" href="../../d2l-page-load-progress/d2l-page-load-progress.html">
<link rel="import" href="../../d2l-simple-overlay/d2l-simple-overlay.html">
<link rel="import" href="../../d2l-simple-overlay/d2l-simple-overlay-close-button.html">
<link rel="import" href="../../d2l-typography/d2l-typography-shared-styles.html">
<link rel="import" href="../behaviors/d2l-upcoming-assessments-behavior.html">
<link rel="import" href="../behaviors/date-behavior.html">
<link rel="import" href="../behaviors/localize-behavior.html">
<link rel="import" href="d2l-all-assessments-list.html">
<link rel="import" href="d2l-assessments-list.html">
<link rel="import" href="d2l-date-dropdown.html">

<dom-module id="d2l-upcoming-assessments">
	<template>
		<style>
			:host {
				display: block;
			}

			h2 {
				font-weight: normal;
				margin-left: 15px;
			}

			d2l-simple-overlay {
				border-top: 0;
				user-select: text;
				-webkit-user-select: text;
				-moz-user-select: text;
				-ms-user-select: text;
			}

			d2l-simple-overlay-close-button {
				line-height: 60px;
				padding: 0px;
			}

			d2l-simple-overlay-close-button span {
				@apply --d2l-body-small-text;
				text-transform: uppercase;
				padding-left: 7px;
			}

			.period-selection-container {
				display: flex;
				justify-content: center;
				margin-bottom: 10px;
			}

			:host-context([dir="rtl"]) h2 {
				margin-left: 0px;
				margin-right: 15px;
			}

			.error-message,
			.no-upcoming-assessments,
			.view-all-container {
				@apply --d2l-body-compact-text;
			}

			.view-all-assignments-link > h3 {
				font-size: 0.7rem;
				font-weight: normal;
				margin-bottom: 0;
			}

			.view-all-assignments-link {
				bottom: 0;
				display: inline-block;
			}

			.no-assessments-in-time-frame {
				text-align: center;
			}

			.view-all-container {
				display: flex;
				justify-content: space-between;
				align-items: center;
				box-sizing: border-box;
				padding: 0 30px;
				margin-left: auto;
				margin-right: auto;
				max-width: 1230px;
			}

			.overlay-close-button-content-wrapper {
				display: inline-flex;
				align-items: center;
				vertical-align: middle;
				border: 1px solid transparent;
				padding: 8px;
				outline: 0;
			}

			.overlay-close-button-content-wrapper:focus, .overlay-close-button-content-wrapper:hover {
				border-radius: 0.3rem;
				border-color: var(--d2l-color-celestuba);
				outline: 0;
			}

			.overlay-close-button-content-wrapper:hover span, .overlay-close-button-content-wrapper:focus span,
			.overlay-close-button-content-wrapper:hover d2l-icon, .overlay-close-button-content-wrapper:focus d2l-icon {
				color: var(--d2l-color-celestuba);
			}

		</style>


		<div class="no-upcoming-assessments"
			 hidden$="[[!_showNoUpcomingAssessmentsMessage(_assessments, _showError)]]">
			 [[_noUpcomingAssessments]]
		</div>

		<template is="dom-if" if="[[_showUpcomingAssessments(_assessments, _showError)]]">
			<d2l-assessments-list assessment-items=[[_assessments]]></d2l-assessments-list>
		</template>

		<div hidden$="[[!_showError]]" class="error-message">[[localize('errorMessage')]]</div>

		<a class="view-all-assignments-link"
			is="d2l-link"
			href="javascript:void(0);"
			on-tap="_openAllAssignmentsView"
			on-keypress="_keypressOpenAllAssignmentsView"
			hidden$=[[_showError]]
			tabindex="0">
			<h3>[[localize('viewAllAssignments')]]</h3>
		</a>

		<d2l-simple-overlay
			id="view-all-assignments-overlay"
			title-name="[[localize('viewAllAssignments')]]"
			close-simple-overlay-alt-text="[[localize('closeSimpleOverlayText')]]"
			no-cancel-on-outside-click
			with-backdrop
			restore-focus-on-close>
			<div slot="header">
				<d2l-page-load-progress id="allAssignmentsProgressBar" autostart color="#003b71"></d2l-page-load-progress>
				<div class="view-all-container">
					<d2l-simple-overlay-close-button>
						<div class="overlay-close-button-content-wrapper">
							<d2l-icon icon="d2l-tier1:chevron-left"></d2l-icon>
							<span>[[_closeSimpleOverlayText]]</span>
						</div>
					</d2l-simple-overlay-close-button>
				</div>
			</div>
			 <div class="period-selection-container">
				 <d2l-date-dropdown
				 	current-period-text=[[_currentPeriodText]]
					locale=[[locale]]
					>
				</d2l-date-dropdown>
			</div>
			<template is="dom-if" if="[[_hasActivities(_allActivities)]]">
				<d2l-all-assessments-list
					assessment-items="[[_allActivities]]"
					period-start="[[_periodStart]]"
					period-end="[[_periodEnd]]">
				</d2l-all-assessments-list>
			</template>
			<div hidden$="[[_hasActivities(_allActivities)]]" class="no-assessments-in-time-frame">[[_noAssessmentsInThisTimeFrame]]</div>

		</d2l-simple-overlay>
	</template>

	<script src="https://s.brightspace.com/lib/siren-parser/6.0.0/siren-parser.js"></script>
	<script>
		'use strict';

		Polymer({
			is: 'd2l-upcoming-assessments',

			properties: {
				userUrl: String,
				loaded: {
					type: Boolean,
					notify: true,
					readOnly: true,
					reflectToAttribute: true,
					value: false
				},
				totalCount: {
					type: Number,
					notify: true,
					readOnly: true,
					reflectToAttribute: true,
					value: 0
				},
				_assessments: {
					type: Array,
					value: function() {
						return [];
					}
				},
				_allActivities: {
					type: Array,
					value: function() {
						return [];
					}
				},
				_userName: String,
				_showError: {
					type: Boolean,
					value: false
				},
				_noUpcomingAssessments: {
					type: String,
					computed: 'localize("noUpcomingAssessments", "userName", _userName)'
				},
				_noAssessmentsInThisTimeFrame: {
					type: String,
					computed: 'localize("noAssessmentsInThisTimeFrame", "userName", _userName)'
				},
				_closeSimpleOverlayText: {
					type: String
				},
				_previousPeriodUrl: String,
				_nextPeriodUrl: String,
				_currentPeriodText: String,
				getToken: {
					type: Object,
					value: null
				},
				_periodStart: String,
				_periodEnd: String,
				_selectCustomDateRangeAction: Object
			},

			behaviors: [
				window.D2L.UpcomingAssessments.UpcomingAssessmentsBehavior,
				window.D2L.UpcomingAssessments.DateBehavior,
				window.D2L.UpcomingAssessments.LocalizeBehavior,
				window.D2L.Hypermedia.HMConstantsBehavior
			],

			listeners: {
				'd2l-date-dropdown-value-changed': '_onDateValueChanged'
			},

			observers: [
				'_onApiConfigChanged(userUrl, getToken)'
			],

			ready: function() {
				var mql = window.matchMedia('(max-width: 767px)');
				this._updateCloseSimpleOverlayText(mql.matches);
				mql.addListener(this._mobileBreakpointListener.bind(this));

				this.$.allAssignmentsProgressBar.finish();
			},

			_debounceTime: 20,

			_getInfo: function() {
				this._showError = false;
				var self = this;

				return this._fetchEntity(this.userUrl, this.getToken)
					.then(function(userEntity) {
						self._userName = (userEntity.getSubEntityByRel(self.HypermediaRels.firstName) || { properties: {} }).properties.name;
						var myActivitiesLink = (userEntity.getLinkByRel(self.HypermediaRels.Activities.myActivities) || {}).href;
						return self._getCustomRangeAction(myActivitiesLink)
							.then(function(customActivitiesLink) {
								return self._loadActivitiesForPeriod(customActivitiesLink);
							})
							.then(function(activities) {
								activities = activities || [];

								var upcomingActivities = activities
									.filter(function(activity) {
										return self.isActivityUpcoming(activity);
									});
								self._setTotalCount(upcomingActivities.length);

								var basicListActivities = upcomingActivities.slice(0, 4);
								self.set('_assessments', basicListActivities);
							})
							.catch(function() {
								self._showError = true;
								self._userName = null;
							});
					});
			},

			_onApiConfigChanged: function() {
				this.debounce('getInfo', this._getInfo, this._debounceTime);
			},

			_showUpcomingAssessments: function(assessments, showError) {
				return !showError && assessments && assessments.length > 0;
			},

			_showNoUpcomingAssessmentsMessage: function(assessments, showError) {
				return !showError && (!assessments || assessments.length <= 0);
			},

			_hasActivities: function(activities) {
				return activities && activities.length > 0;
			},

			_updateActivitiesInfo: function(activities) {
				activities = activities || [];
				return activities
					.filter(function(activity) {
						return activity.dueDate || activity.endDate;
					})
					.sort(function(a, b) {
						return (a.dueDate || a.endDate) > (b.dueDate || b.endDate);
					});
			},

			_keypressOpenAllAssignmentsView: function(e) {
				if ( e.code === 'Space' || e.code === 'Enter' ) {
					return this._openAllAssignmentsView(e);
				}
			},

			_openAllAssignmentsView: function() {
				this.$['view-all-assignments-overlay'].open();
			},

			_onDateValueChanged: function(e) {
				if (e.detail.date) {
					var parameters = this._getCustomDateRangeParameters(e.detail.date);
					var periodUrl = this._createActionUrl(this._selectCustomDateRangeAction, parameters);
					return this._loadActivitiesForPeriod(periodUrl)
					.catch(function() {
						self._showError = true;
						self._userName = null;
					});
				}
			},

			_getCustomRangeAction: function(activitiesUrl) {
				if (!activitiesUrl) {
					return Promise.reject();
				}

				var self = this;

				return this._fetchEntity(activitiesUrl, this.getToken, this.userUrl)
					.then(function(activities) {
						var currentTime = new Date();
						currentTime.setHours(0, 0, 0, 0);
						var parameters = self._getCustomDateRangeParameters(currentTime);

						var action = (activities.getActionByName(self.HypermediaActions.activities.selectCustomDateRange) || {});
						self._selectCustomDateRangeAction = action;

						return self._createActionUrl(action, parameters);
					});
			},

			_getCustomDateRangeParameters: function(selectedDate) {
				var day = selectedDate.getDay();
				var startDate = new Date(selectedDate.setDate(selectedDate.getDate() - day));
				var start = startDate.toISOString();
				var twoWeeksFromStart = new Date(startDate.setDate(startDate.getDate() + 13));
				twoWeeksFromStart.setHours(23, 59, 59, 999);
				var end = twoWeeksFromStart.toISOString();

				return {
					start: start,
					end: end
				};
			},

			_createActionUrl: function(action, parameters) {
				var query = {};
				if (action.fields) {
					action.fields.forEach(function(field) {
						if (parameters.hasOwnProperty(field.name)) {
							query[field.name] = parameters[field.name];
						} else {
							query[field.name] = field.value;
						}
					});
				}

				var queryString = Object.keys(query).map(function(key) {
					return key + '=' + query[key];
				}).join('&');

				return queryString ? action.href + '?' + queryString : action.href;
			},

			_loadActivitiesForPeriod: function(periodUrl) {
				if (!periodUrl) {
					return Promise.reject();
				}

				var self = this;
				var userActivityUsages;

				var progress = this.$.allAssignmentsProgressBar;
				progress.start();

				return this._fetchEntity(periodUrl, this.getToken, this.userUrl)
					.then(function(userUsages) {
						userActivityUsages = userUsages;
						self._previousPeriodUrl = (userActivityUsages.getLinkByRel(self.HypermediaRels.Activities.previousPeriod) || {}).href;
						self._nextPeriodUrl = (userActivityUsages.getLinkByRel(self.HypermediaRels.Activities.nextPeriod) || {}).href;
						self._currentPeriodText = self._getFormattedPeriodText(userActivityUsages.properties.start, userActivityUsages.properties.end);
						self._periodStart = userActivityUsages.properties.start;
						self._periodEnd = userActivityUsages.properties.end;

						return self._getOverdueActivities(userActivityUsages, self.getToken, self.userUrl);
					})
					.then(function(overdueUserActivityUsages) {
						return self._getUserActivityUsagesInfos(userActivityUsages, overdueUserActivityUsages, self.getToken, self.userUrl);
					})
					.then(function(userActivityUsagesInfos) {
						return self._updateActivitiesInfo(userActivityUsagesInfos, self.getToken, self.userUrl);
					})
					.then(function(activities) {
						self.set('_allActivities', activities);
						progress.finish();
						self._setLoaded(true);
						return activities;
					});
			},

			_getFormattedPeriodText: function(startDate, endDate) {
				var startDateDate = new Date(startDate);
				var endDateDate = new Date(endDate);

				var startDateString = new window.d2lIntl.DateTimeFormat(this.locale, { format: 'monthDay' }).format(startDateDate);
				var endDateString;
				if (startDateDate && endDateDate && (startDateDate.getMonth() === endDateDate.getMonth())) {
					endDateString = endDateDate.getDate();
				} else {
					endDateString = new window.d2lIntl.DateTimeFormat(this.locale, { format: 'monthDay' }).format(endDateDate);
				}

				return this.localize('currentPeriod', 'startDate', startDateString, 'endDate', endDateString);
			},

			_mobileBreakpointListener: function(mqlevent) {
				this._updateCloseSimpleOverlayText(mqlevent.matches);
			},

			_updateCloseSimpleOverlayText: function(isMobile) {
				this._closeSimpleOverlayText = isMobile
					? this.localize('closeSimpleOverlayTextMobile')
					: this.localize('closeSimpleOverlayText');
			}
		});

	</script>
</dom-module>
