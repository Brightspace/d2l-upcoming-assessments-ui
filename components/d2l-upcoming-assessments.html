<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-ajax/iron-ajax.html">
<link rel="import" href="../../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">
<link rel="import" href="../../d2l-link/d2l-link.html">
<link rel="import" href="../../d2l-simple-overlay/d2l-simple-overlay.html">
<link rel="import" href="../../d2l-simple-overlay/d2l-simple-overlay-close-button.html">
<link rel="import" href="../../d2l-typography/d2l-typography-shared-styles.html">
<link rel="import" href="../src/localize-behavior.html">
<link rel="import" href="d2l-assessments-list.html">

<dom-module id="d2l-upcoming-assessments">
	<template>
		<style>
			:host {
				display: block;
			}

			h2 {
				font-weight: normal;
				margin-left: 15px;
			}

			d2l-simple-overlay-close-button {
				line-height: 60px;
				padding: 0px;
			}

			d2l-simple-overlay-close-button span {
				text-transform: uppercase;
			}

			:host-context([dir="rtl"]) h2 {
				margin-left: 0px;
				margin-right: 15px;
			}

			.error-message,
			.no-upcoming-assessments,
			.view-all-assignments-link > h3,
			.view-all-container {
				@apply --d2l-body-compact-text;
			}

			.view-all-assignments-link > h3 {
				margin-bottom: 0;
			}

			.no-assessments-in-time-frame {
				text-align: center;
			}

			.view-all-container {
				display: flex;
				justify-content: space-between;
				align-items: center;
				box-sizing: border-box;
				padding: 0 30px;
				margin-left: auto;
				margin-right: auto;
				max-width: 1230px;
			}
		</style>

		<iron-ajax
			id="assessmentsRequest"
			url="[[assessmentsUrl]]"
			handle-as="json"
			on-iron-ajax-response="_onAssessmentsResponse"
			on-iron-ajax-error="_onError">
		</iron-ajax>

		<iron-ajax
			id="userRequest"
			url="[[userUrl]]"
			handle-as="json"
			on-iron-ajax-response="_onUserResponse"
			on-iron-ajax-error="_onError">
		</iron-ajax>

		<template is="dom-if" if="[[!_hasUpcomingAssessments(_assessments)]]">
			<div class="no-upcoming-assessments">[[_noUpcomingAssessmentsMessage]]</div>
		</template>

		<template is="dom-if" if="[[_hasUpcomingAssessments(_assessments)]]">
			<d2l-assessments-list assessment-items=[[_assessments]]></d2l-assessments-list>
		</template>

		<template is="dom-if" if="[[_showError]]">
			<div class="error-message">[[localize('errorMessage')]]</div>
		</template>

		<a class="view-all-assignments-link"
			is="d2l-link"
			on-tap="_openAllAssignmentsView"
			on-keypress="_keypressOpenAllAssignmentsView" >
			<h3>[[localize('viewAllAssignments')]]</h3>
		</a>

		<d2l-simple-overlay
			id="view-all-assignments-overlay"
			title-name="[[localize('viewAllAssignments')]]"
			locale="[[locale]]"
			close-simple-overlay-alt-text="[[localize('closeSimpleOverlayText')]]"
			with-backdrop>
			<div class="view-all-container" slot="header">
				<d2l-simple-overlay-close-button>
					<d2l-icon icon="d2l-tier1:chevron-left"></d2l-icon>
					<span>[[localize('closeSimpleOverlayText')]]</span>
				</d2l-simple-overlay-close-button>
			</div>
			<div class="no-assessments-in-time-frame">[[_noAssessmentsInThisTimeFrame]]</div>
		</d2l-simple-overlay>
	</template>

	<script src="https://s.brightspace.com/lib/siren-parser/6.0.0/siren-parser.js"></script>
	<script>
		'use strict';

		Polymer({
			is: 'd2l-upcoming-assessments',

			properties: {
				assessmentsUrl: String,
				userUrl: String,
				token: String,
				_assessments: {
					type: Array,
					value: function() {
						return [];
					}
				},
				_userName: String,
				_showError: {
					type: Boolean,
					value: false
				},
				_noUpcomingAssessmentsMessage: String,
				_noAssessmentsInThisTimeFrame: String
			},

			behaviors: [
				window.D2L.UpcomingAssessments.LocalizeBehavior,
				window.D2L.Hypermedia.HMConstantsBehavior
			],

			observers: [
				'_onAssessmentsUrlChanged(assessmentsUrl, token)',
				'_onUserUrlChanged(userUrl, token)'
			],

			_onAssessmentsResponse: function(response) {
				if (response.detail.status === 200 || response.detail.status === 304) {
					this._showError = false;
					this.set('_assessments', response.detail.xhr.response);
				} else {
					this._onError();
				}
			},

			_onUserResponse: function(response) {
				if (response.detail.status === 200 || response.detail.status === 304) {
					var userEntity = window.D2L.Hypermedia.Siren.Parse(response.detail.xhr.response);

					this._userName = (userEntity.getSubEntityByRel(this.HypermediaRels.firstName) || { properties: {} }).properties.name;
					this._showError = false;
					this._noUpcomingAssessmentsMessage = this.localize('noUpcomingAssessments', 'userName', this._userName);
					this._noAssessmentsInThisTimeFrame = this.localize('noAssessmentsInThisTimeFrame', 'userName', this._userName);
				} else {
					this._onError();
				}
			},

			_getAssessmentsInfo: function() {
				this.$.assessmentsRequest.headers = {
					Authorization: 'Bearer ' + this.token
				};
				this.$.assessmentsRequest.generateRequest();
			},

			_getUserInfo: function() {
				this.$.userRequest.headers = {
					Authorization: 'Bearer ' + this.token
				};
				this.$.userRequest.generateRequest();
			},

			_onError: function() {
				this._showError = true;
			},

			_onAssessmentsUrlChanged: function() {
				this.debounce('getAssessmentsInfo', this._getAssessmentsInfo, this._debounceTime);
			},

			_onUserUrlChanged: function() {
				this.debounce('getUserInfo', this._getUserInfo, this._debounceTime);
			},

			_hasUpcomingAssessments: function() {
				return this._assessments && this._assessments.length > 0;
			},

			_keypressOpenAllAssignmentsView: function(e) {
				if ( e.code === 'Space' || e.code === 'Enter' ) {
					return this._openAllAssignmentsView(e);
				}
			},

			_openAllAssignmentsView: function() {
				this.$['view-all-assignments-overlay'].open();
			},

			_debounceTime: 250
		});

	</script>
</dom-module>
